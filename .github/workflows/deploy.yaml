name: Deploy to EC2 (Docker Compose)

# Trigger on pushes to main
on:
  push:
    branches:
      - main
  workflow_dispatch: # allows manual run from Actions tab
    inputs:
      target_branch:
        description: 'Branch to deploy'
        required: false
        default: 'main'

permissions:
  contents: read

concurrency:
  group: deploy-to-ec2
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # Optional: show repo root for debug
      - name: List repo (debug)
        run: ls -la

      # Use scp to copy files to EC2. Adjust `source` if you want to exclude large folders.
      - name: Copy repository to EC2 (SCP)
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          port: ${{ secrets.SSH_PORT || '22' }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: |
            . 
            !.git
            !node_modules
            !**/node_modules
            !**/target
          target: ${{ secrets.REMOTE_APP_PATH || '/home/deploy/app' }}
          strip_components: 0

      # SSH into EC2 and run deployment commands.
      - name: Remote deploy — write .env and run docker compose
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          port: ${{ secrets.SSH_PORT || '22' }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 120000
          script: |
            set -euo pipefail

            APP_DIR="${{ secrets.REMOTE_APP_PATH || '/home/deploy/app' }}"
            echo "Deploying into: $APP_DIR"
            sudo mkdir -p "$APP_DIR"
            sudo chown -R ${{ secrets.EC2_USER }}:$${{ secrets.EC2_USER }} "$APP_DIR"
            cd "$APP_DIR" || exit 1

            # Write .env.production from secret (passed as env below)
            if [ -n "$PROD_ENV" ]; then
              echo "Writing .env.production (from secret)"
              printf "%s\n" "$PROD_ENV" > "$APP_DIR/.env.production"
              sudo chown ${{ secrets.EC2_USER }}:$${{ secrets.EC2_USER }} "$APP_DIR/.env.production"
              sudo chmod 600 "$APP_DIR/.env.production"
            else
              echo "WARNING: PROD_ENV empty — .env.production not written"
            fi

            # Ensure correct docker socket access; prefer using sudo if necessary
            if sudo -n true 2>/dev/null; then
              echo "Using sudo to run docker compose"
              sudo docker compose down --remove-orphans || true
              sudo docker compose up -d --build --remove-orphans
            else
              echo "Running docker compose without sudo"
              docker compose down --remove-orphans || true
              docker compose up -d --build --remove-orphans
            fi

            echo "Deployment finished. Showing compose ps:"
            if sudo -n true 2>/dev/null; then
              sudo docker compose ps
            else
              docker compose ps
            fi
        env:
          PROD_ENV: ${{ secrets.PROD_ENV }}
